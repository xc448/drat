<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rcpp Functions • PanelPRO</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/lumen/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Rcpp Functions">
<meta property="og:description" content="Rcpp functions are functions written in C++ and are made available in R by the package Rcpp. The package RcppArmadillo is also needed to run some tensor operations
">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">PanelPRO</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/building-pedigrees.html">Building PanelPRO Pedigrees</a>
    </li>
    <li>
      <a href="../articles/rcpp-functions.html">Rcpp Functions</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Rcpp Functions</h1>
            
      
      
      <div class="hidden name"><code>rcpp-functions.Rmd</code></div>

    </div>

    
    
<p>We have incorporated functions written in C++ to reduce the
computational runtime of the peeling-paring algorithm in the
<code>PanelPRO</code> package. It is well known that R is not the
fastest programming language and has a large overhead for function
calls. In <code>PanelPRO</code>, a recursive implementation of peeling
and paring forms the backbone for computing carrier probabilities. The
runtime of this algorithm (Fernando et al., 1993) scales exponentially
with the number of genes in model, so it is important to keep this
runtime low as the number of genes increases.</p>
<p>This vignette describes how we have re-written some of the
time-consuming functions in C++, giving a clinically significant
reduction in runtime.</p>
<div class="section level2">
<h2 id="required-packages">Required packages<a class="anchor" aria-label="anchor" href="#required-packages"></a>
</h2>
<p>The interface between C++ and R is provided by the R package
<code>Rcpp</code>. Compared to a regular R package, there are a few
differences to ensure that the C++ code is made available to other
functions in the package. We refer to <a href="https://adv-r.hadley.nz/rcpp.html" class="external-link uri">https://adv-r.hadley.nz/rcpp.html</a> and in particular <a href="https://adv-r.hadley.nz/rcpp.html#rcpp-package" class="external-link uri">https://adv-r.hadley.nz/rcpp.html#rcpp-package</a> for more
details. Essentially, this boils down to adding the following to the
<code>DESCRIPTION</code> file:</p>
<pre><code>LinkingTo: Rcpp, RcppArmadillo  
Imports: Rcpp (&gt;= 1.0.3)  </code></pre>
<p>The RcppArmadillo package is another R/C++ interface that provides a
linear algebra toolkit (see <a href="http://arma.sourceforge.net/" class="external-link uri">http://arma.sourceforge.net/</a> and <a href="https://cran.r-project.org/web/packages/RcppArmadillo/index.html" class="external-link uri">https://cran.r-project.org/web/packages/RcppArmadillo/index.html</a>).</p>
<p>Some additional software may be required to compile C++. Windows
requires <code>RTools</code> and Mac OS requires
<code>Xcode Developer Tools</code>. Linux should have a built-in C++
compiler.</p>
</div>
<div class="section level2">
<h2 id="where-to-put-the-c-code">Where to put the C++ code<a class="anchor" aria-label="anchor" href="#where-to-put-the-c-code"></a>
</h2>
<p>The C++ code lives in the folder <code>PanelPRO\src</code>, where
header files (<code>.h</code>) declare and document functions and
implementation files (<code>.cpp</code>) contain the function
definitions.</p>
</div>
<div class="section level2">
<h2 id="building-the-package">Building the package<a class="anchor" aria-label="anchor" href="#building-the-package"></a>
</h2>
<p>Once any necessary software for compiling C++ has been installed and
the appropriate header/implementation files have been placed in
<code>PanelPRO\src</code> the <code>PanelPRO</code> package can be
built. For example, in RStudio, the <strong>Clean and Rebuild</strong>
function calls <code><a href="https://rdrr.io/pkg/Rcpp/man/compileAttributes.html" class="external-link">Rcpp::compileAttributes()</a></code>, which compiles
the C++ code and packages the remaining R code.</p>
<p><br></p>
</div>
<div class="section level2">
<h2 id="overview-of-functions-written-in-c">Overview of functions written in C++<a class="anchor" aria-label="anchor" href="#overview-of-functions-written-in-c"></a>
</h2>
<p>The bulk of the runtime gain comes from the C++ implementation of the
peeling and paring algorithm. We have also re-written functions that
rely on <code>for</code> loops, which are notoriously slow in R. Note
that in C++, indexing starts at 0, whereas in R it starts at 1.</p>
<div class="section level3">
<h3 id="inheritance-probability-calculation">Inheritance probability calculation<a class="anchor" aria-label="anchor" href="#inheritance-probability-calculation"></a>
</h3>
<p>This has been renamed <code>calInheritanceProb</code> and is a
straightforward ‘translation’ of the corresponding R code, now
deprecated.</p>
</div>
<div class="section level3">
<h3 id="genotype-prevalence-calculation">Genotype prevalence calculation<a class="anchor" aria-label="anchor" href="#genotype-prevalence-calculation"></a>
</h3>
<p>This has been renamed <code>calPrevalences</code> and is a
straightforward ‘translation’ of the corresponding R code, now
deprecated.</p>
</div>
<div class="section level3">
<h3 id="peeling-and-paring-algorithm">Peeling and paring algorithm<a class="anchor" aria-label="anchor" href="#peeling-and-paring-algorithm"></a>
</h3>
<p>The helper functions for this algorithm are in
<code>peelingParingHelper.cpp</code> and the main function call is in
<code>peelingParing.cpp</code>. <code>idx</code> indicates the
corresponding row number in the pedigree data frame, and not the
<code>ID</code> identifiers in the pedigree. This results in fewer
look-ups needed each time an individual in the pedigree is accessed.</p>
<p>The paper Fernando et al. 1993 should be read in conjunction with the
implementation of the peeling algorithm. Equation numbers referring to
the paper have been quoted in comments throughout the function code to
ease interpretability.</p>
<p>There has been a conscious decision to sacrifice some readability in
favor of performance by vectorizing functions instead of writing loops,
and also by making <strong>in place</strong> function calls. Therefore,
the algorithm alters underlying pieces of memory by reference and avoids
copying. This is essential for ensuring adequate performance. In
particular, <code>mat.each_col</code> or <code>mat.each_row</code> or
<code>cube.each_slice</code> are key operations.</p>
<p>The implementation intentionally mimics the now-deprecated R
implementation, but with more readability. The <code>sweep</code>
function was used extensively in the R implementation; while useful this
hid recycling of margins (also known as ‘broadcasting’) and data
types.</p>
</div>
</div>
<div class="section level2">
<h2 id="calling-c-within-r">Calling C++ within R<a class="anchor" aria-label="anchor" href="#calling-c-within-r"></a>
</h2>
<p>Once the package has been compiled, the C++ functions are made
available to R within the package. R objects (such as matrices and data
frames) can be passed to C++ and one can then execute these functions.
For example:</p>
<pre><code><span><span class="va">posterior_probs</span> <span class="op">&lt;-</span> <span class="fu">peelingParing</span><span class="op">(</span><span class="va">probandIndexes</span>, <span class="va">idMatrix</span>, <span class="va">E</span>, <span class="va">C</span>, </span>
<span>                                 <span class="va">prev</span>, <span class="va">LIK</span>, <span class="va">TR</span>, <span class="va">antProb</span>, <span class="va">postProb</span><span class="op">)</span></span></code></pre>
<p>where <code>peelingParing</code> is a C++ function and the arguments
are R objects.</p>
<p><br></p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Fernando, R. L., C. Stricker, and R. C. Elston. “An efficient
algorithm to compute the posterior genotypic distribution for every
member of a pedigree without loops.” Theoretical and Applied Genetics
87.1 (1993): 89-93.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by BayesMendel Lab, Theo Huang, Gavin Lee, Jane Liang, Tom Madsen, Qing Zhang.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
